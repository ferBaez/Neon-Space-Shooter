import React, { useCallback } from 'react';
import { InputState } from '../types';

interface ControlsProps {
  inputRef: React.MutableRefObject<InputState>;
  className?: string;
  btnSizeClass?: string;
}

// Reusable styling
const btnBase = "rounded-full border-2 bg-white/5 backdrop-blur-md flex items-center justify-center text-2xl select-none transition-all touch-none active:scale-90 shadow-lg";

export const ShootButton: React.FC<ControlsProps> = ({ inputRef, className = '', btnSizeClass = "w-20 h-20 sm:w-24 sm:h-24" }) => {
  const handleTouch = useCallback((active: boolean) => (e: React.TouchEvent | React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    inputRef.current.shoot = active;
    if (active && navigator.vibrate) navigator.vibrate(10);
  }, [inputRef]);

  return (
    <button
      className={`${btnBase} ${btnSizeClass} border-red-500/50 text-red-500 shadow-red-900/20 active:bg-red-500 active:text-white ${className}`}
      onMouseDown={handleTouch(true)}
      onMouseUp={handleTouch(false)}
      onMouseLeave={handleTouch(false)}
      onTouchStart={handleTouch(true)}
      onTouchEnd={handleTouch(false)}
      aria-label="Shoot"
    >
      ðŸ”¥
    </button>
  );
};

export const DPad: React.FC<ControlsProps> = ({ inputRef, className = '', btnSizeClass = "w-20 h-20 sm:w-24 sm:h-24" }) => {
  const handleTouch = useCallback((key: 'left' | 'right', active: boolean) => (e: React.TouchEvent | React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    inputRef.current[key] = active;
    if (active && navigator.vibrate) navigator.vibrate(10);
  }, [inputRef]);

  return (
    <div className={`flex gap-4 ${className}`}>
      <button
        className={`${btnBase} ${btnSizeClass} border-cyan-400/50 text-cyan-400 shadow-cyan-900/20 active:bg-cyan-400 active:text-black`}
        onMouseDown={handleTouch('left', true)}
        onMouseUp={handleTouch('left', false)}
        onMouseLeave={handleTouch('left', false)}
        onTouchStart={handleTouch('left', true)}
        onTouchEnd={handleTouch('left', false)}
        aria-label="Move Left"
      >
        â—€
      </button>
      <button
        className={`${btnBase} ${btnSizeClass} border-cyan-400/50 text-cyan-400 shadow-cyan-900/20 active:bg-cyan-400 active:text-black`}
        onMouseDown={handleTouch('right', true)}
        onMouseUp={handleTouch('right', false)}
        onMouseLeave={handleTouch('right', false)}
        onTouchStart={handleTouch('right', true)}
        onTouchEnd={handleTouch('right', false)}
        aria-label="Move Right"
      >
        â–¶
      </button>
    </div>
  );
};

// Default composite component for Portrait mode
const MobileControls: React.FC<ControlsProps> = (props) => {
  return (
    <div className={`flex justify-between items-center w-full px-8 py-4 ${props.className || ''}`}>
      <div className="pointer-events-auto">
        <ShootButton {...props} />
      </div>
      <div className="pointer-events-auto">
        <DPad {...props} />
      </div>
    </div>
  );
};

export default MobileControls;
